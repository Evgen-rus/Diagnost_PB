# –ü–ª–∞–Ω —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª–Ω–æ—Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –ø–æ–∏—Å–∫–∞ FTS5

> **üìã –û–±–Ω–æ–≤–ª–µ–Ω–æ**: –ü–ª–∞–Ω –∞–∫—Ç—É–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω —Å —É—á–µ—Ç–æ–º –∑–∞–≤–µ—Ä—à–µ–Ω–Ω–æ–≥–æ –ø–µ—Ä–µ—Ö–æ–¥–∞ –Ω–∞ –∫–æ—Å–∏–Ω—É—Å–Ω–æ–µ —Å—Ö–æ–¥—Å—Ç–≤–æ (IndexFlatIP). –í—Å–µ –ø—Ä–∏–º–µ—Ä—ã –∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —É—á–∏—Ç—ã–≤–∞—é—Ç –Ω–æ–≤—É—é –º–µ—Ç—Ä–∏–∫—É similarity –≤–º–µ—Å—Ç–æ distance.

## –¶–µ–ª—å
–°–æ–∑–¥–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–π –º–æ–¥—É–ª—å `utils/fts_search.py` –¥–ª—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –ø–æ–ª–Ω–æ—Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –ø–æ–∏—Å–∫–∞ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º SQLite FTS5, –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º –≤–µ–∫—Ç–æ—Ä–Ω—ã–º –ø–æ–∏—Å–∫–æ–º –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–æ—Å–∏–Ω—É—Å–Ω–æ–≥–æ —Å—Ö–æ–¥—Å—Ç–≤–∞.

## –ß—Ç–æ —Ç–∞–∫–æ–µ SQLite FTS5?

**FTS5** = **F**ull **T**ext **S**earch –≤–µ—Ä—Å–∏—è 5 - –≤—Å—Ç—Ä–æ–µ–Ω–Ω–æ–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ SQLite –¥–ª—è –ø–æ–ª–Ω–æ—Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –ø–æ–∏—Å–∫–∞.

### –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ FTS5:
- ‚úÖ **–¢–æ—á–Ω—ã–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è** - –Ω–∞—Ö–æ–¥–∏—Ç –≤—Å–µ –≤—Ö–æ–∂–¥–µ–Ω–∏—è —Ç–µ—Ä–º–∏–Ω–æ–≤
- ‚úÖ **–ë—ã—Å—Ç—Ä—ã–π –ø–æ–∏—Å–∫** - –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã
- ‚úÖ **–ê–ª–≥–æ—Ä–∏—Ç–º BM25** - —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–µ —Ä–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏
- ‚úÖ **–ú–æ—Ä—Ñ–æ–ª–æ–≥–∏—è** - –ø–æ–¥–¥–µ—Ä–∂–∫–∞ wildcards –¥–ª—è —Ä—É—Å—Å–∫–æ–≥–æ —è–∑—ã–∫–∞
- ‚úÖ **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è** - —Ä–∞–±–æ—Ç–∞–µ—Ç –≤–Ω—É—Ç—Ä–∏ SQLite

### –†–∞–∑–ª–∏—á–∏—è —Å –≤–µ–∫—Ç–æ—Ä–Ω—ã–º –ø–æ–∏—Å–∫–æ–º:

| –ö—Ä–∏—Ç–µ—Ä–∏–π | –í–µ–∫—Ç–æ—Ä–Ω—ã–π FAISS (Cosine) | FTS5 |
|----------|---------------------------|------|
| **–ü—Ä–∏–Ω—Ü–∏–ø** | –°–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–æ–µ —Å—Ö–æ–¥—Å—Ç–≤–æ | –õ–µ–∫—Å–∏—á–µ—Å–∫–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ |
| **–ú–µ—Ç—Ä–∏–∫–∞** | Cosine similarity (0-1) | BM25 score |
| **–°–∏–Ω–æ–Ω–∏–º—ã** | –ü–æ–Ω–∏–º–∞–µ—Ç | –ù–µ –ø–æ–Ω–∏–º–∞–µ—Ç |
| **–¢–æ—á–Ω—ã–µ —Ç–µ—Ä–º–∏–Ω—ã** | –ú–æ–∂–µ—Ç –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å | –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ –Ω–∞–π–¥–µ—Ç |
| **–ú–æ—Ä—Ñ–æ–ª–æ–≥–∏—è** | –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ | –ß–µ—Ä–µ–∑ wildcards |
| **–°–∫–æ—Ä–æ—Å—Ç—å** | –ë—ã—Å—Ç—Ä–æ | –û—á–µ–Ω—å –±—ã—Å—Ç—Ä–æ |

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ

- **–ù–æ–≤—ã–π –º–æ–¥—É–ª—å**: `utils/fts_search.py` - –æ—Ç–¥–µ–ª—å–Ω—ã–π –æ—Ç –≤–µ–∫—Ç–æ—Ä–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞
- **–í–∏—Ä—Ç—É–∞–ª—å–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞**: `chunks_fts` —Å—Å—ã–ª–∞–µ—Ç—Å—è –Ω–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é `chunks`
- **–ì–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–∏—Å–∫**: –í `utils/vector_search.py` –¥–æ–±–∞–≤–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏—é –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
- **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è**: –û–±–Ω–æ–≤–∏—Ç—å –æ—Å–Ω–æ–≤–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –Ω–æ–≤–æ–≥–æ –º–æ–¥—É–ª—è
```
utils/fts_search.py
‚îú‚îÄ‚îÄ prepare_fts_query()       # –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –¥–ª—è FTS5
‚îú‚îÄ‚îÄ init_fts_table()          # –°–æ–∑–¥–∞–Ω–∏–µ FTS5 —Ç–∞–±–ª–∏—Ü—ã
‚îú‚îÄ‚îÄ populate_fts_table()      # –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ FTS5 –¥–∞–Ω–Ω—ã–º–∏
‚îú‚îÄ‚îÄ search_fts_chunks()       # –ü–æ–ª–Ω–æ—Ç–µ–∫—Å—Ç–æ–≤—ã–π –ø–æ–∏—Å–∫
‚îú‚îÄ‚îÄ update_fts_chunk()        # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —á–∞–Ω–∫–∞ –≤ FTS5
‚îî‚îÄ‚îÄ rebuild_fts_index()       # –ü–µ—Ä–µ—Å–±–æ—Ä–∫–∞ –∏–Ω–¥–µ–∫—Å–∞
```

## –ê–ª–≥–æ—Ä–∏—Ç–º —Ä–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏—è BM25 –¥–ª—è –≤—ã–±–æ—Ä–∞ TOP-3 —á–∞–Ω–∫–æ–≤

**FTS5 –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∞–ª–≥–æ—Ä–∏—Ç–º BM25 (Best Matching 25)** –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏ —á–∞–Ω–∫–æ–≤:

### –§–∞–∫—Ç–æ—Ä—ã —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏:
1. **–ß–∞—Å—Ç–æ—Ç–∞ —Å–ª–æ–≤–∞ –≤ –¥–æ–∫—É–º–µ–Ω—Ç–µ (TF)** - —á–µ–º —á–∞—â–µ —Å–ª–æ–≤–æ –≤—Å—Ç—Ä–µ—á–∞–µ—Ç—Å—è, —Ç–µ–º –≤—ã—à–µ score
2. **–†–µ–¥–∫–æ—Å—Ç—å —Å–ª–æ–≤–∞ –≤ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ (IDF)** - —Ä–µ–¥–∫–∏–µ —Ç–µ—Ä–º–∏–Ω—ã –ø–æ–ª—É—á–∞—é—Ç –±–æ–ª—å—à–∏–π –≤–µ—Å
3. **–î–ª–∏–Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞** - –∫–æ—Ä–æ—Ç–∫–∏–µ —Å—Ñ–æ–∫—É—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —á–∞–Ω–∫–∏ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–µ–µ
4. **–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö —Ç–µ—Ä–º–∏–Ω–æ–≤** - –±–æ–ª—å—à–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π = –≤—ã—à–µ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å

### SQL –∑–∞–ø—Ä–æ—Å –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è TOP-3:
```sql
SELECT chunk_id, chunk_text, bm25(chunks_fts) as relevance_score
FROM chunks_fts 
WHERE chunks_fts MATCH '–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–π_–∑–∞–ø—Ä–æ—Å'
ORDER BY relevance_score DESC
LIMIT 3;
```

### –ü—Ä–∏–º–µ—Ä —Ä–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏—è:
```python
# –ó–∞–ø—Ä–æ—Å: "–¥–µ—Ñ–µ–∫—Ç—ã —Å–≤–∞—Ä–Ω—ã—Ö —à–≤–æ–≤" ‚Üí "–¥–µ—Ñ–µ–∫—Ç—ã* —Å–≤–∞—Ä–Ω—ã—Ö* —à–≤–æ–≤*"
# –†–µ–∑—É–ª—å—Ç–∞—Ç—ã:
chunk_1 = "–¥–µ—Ñ–µ–∫—Ç—ã –≤ —Å–≤–∞—Ä–Ω—ã—Ö —à–≤–∞—Ö –º–µ—Ç–∞–ª–ª–∞"        # Score: 8.95 (–≤—Å–µ —Ç–µ—Ä–º–∏–Ω—ã + –≤—ã—Å–æ–∫–∞—è –ø–ª–æ—Ç–Ω–æ—Å—Ç—å)
chunk_2 = "–æ–±–Ω–∞—Ä—É–∂–µ–Ω –¥–µ—Ñ–µ–∫—Ç —Å–≤–∞—Ä–Ω–æ–≥–æ —à–≤–∞"         # Score: 7.23 (–≤—Å–µ —Ç–µ—Ä–º–∏–Ω—ã + –º–æ—Ä—Ñ–æ–ª–æ–≥–∏—è)  
chunk_3 = "–¥–µ—Ñ–µ–∫—Ç—ã –º–µ—Ç–∞–ª–ª–∞ –∏ —Å–≤–∞—Ä–Ω—ã—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π"  # Score: 6.81 (2 –∏–∑ 3 —Ç–µ—Ä–º–∏–Ω–æ–≤)
```

## IMPLEMENTATION CHECKLIST:

### 1. **–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π —Ñ–∞–π–ª `utils/fts_search.py`**
   - –ò–º–ø–æ—Ä—Ç—ã: sqlite3, logging, typing, utils.exceptions
   - –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–≥–µ—Ä–∞ –¥–ª—è FTS –º–æ–¥—É–ª—è

### 2. **–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é `init_fts_table(conn: sqlite3.Connection)`**
   - –°–æ–∑–¥–∞–Ω–∏–µ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã chunks_fts —Å FTS5
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã
   - –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏—Å–∫–ª—é—á–µ–Ω–∏–π

### 3. **–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é `populate_fts_table(conn: sqlite3.Connection)`**
   - –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ FTS5 —Ç–∞–±–ª–∏—Ü—ã –¥–∞–Ω–Ω—ã–º–∏ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã chunks
   - –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä –¥–ª—è –±–æ–ª—å—à–∏—Ö –æ–±—ä–µ–º–æ–≤ –¥–∞–Ω–Ω—ã—Ö
   - –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

### 4. **–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é `prepare_fts_query(query: str) -> str`**
   - –≠–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤ FTS5 (", ', *, :, ^, (), [])
   - –ü—Ä–∏–≤–µ–¥–µ–Ω–∏–µ –∫ –Ω–∏–∂–Ω–µ–º—É —Ä–µ–≥–∏—Å—Ç—Ä—É
   - –î–æ–±–∞–≤–ª–µ–Ω–∏–µ wildcards (*) –¥–ª—è —Ä—É—Å—Å–∫–æ–π –º–æ—Ä—Ñ–æ–ª–æ–≥–∏–∏ (—Ç–æ–ª—å–∫–æ –¥–ª—è —Å–ª–æ–≤ –¥–ª–∏–Ω–Ω–µ–µ 3 —Å–∏–º–≤–æ–ª–æ–≤)
   - –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –¥–ª–∏–Ω—ã –∑–∞–ø—Ä–æ—Å–∞ (–º–∞–∫—Å 1000 —Å–∏–º–≤–æ–ª–æ–≤)
   - –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–æ–±–µ–ª–æ–≤

### 5. **–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é `search_fts_chunks(query: str, conn: sqlite3.Connection, top_k: int = 3)`**
   - –í—ã–∑–æ–≤ prepare_fts_query() –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
   - –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø–æ–ª–Ω–æ—Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –ø–æ–∏—Å–∫–∞ —Å —Ä–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏–µ–º BM25
   - –í–æ–∑–≤—Ä–∞—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –≤ —Ñ–æ—Ä–º–∞—Ç–µ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ–º —Å –≤–µ–∫—Ç–æ—Ä–Ω—ã–º –ø–æ–∏—Å–∫–æ–º (—Å –ø–æ–ª–µ–º 'similarity')

### 6. **–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é `update_fts_chunk(chunk_id: str, content: str, conn: sqlite3.Connection)`**
   - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —á–∞–Ω–∫–∞ –≤ FTS5
   - –î–ª—è –±—É–¥—É—â–∏—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π

### 7. **–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é `rebuild_fts_index(conn: sqlite3.Connection)`**
   - –ü–µ—Ä–µ—Å–±–æ—Ä–∫–∞ –∏–Ω–¥–µ–∫—Å–∞ FTS5
   - –î–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

### 8. **–î–æ–±–∞–≤–∏—Ç—å –≤ `config.py` –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ FTS5**
   - FTS_ENABLED = True
   - FTS_TOP_K = 3
   - VECTOR_TOP_K = 3
   - HYBRID_TOTAL_CHUNKS = 6
   - –î–æ–±–∞–≤–∏—Ç—å –≤ –±–ª–æ–∫ # Vector search configuration

### 9. **–°–æ–∑–¥–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é `hybrid_search_chunks()` –≤ `utils/vector_search.py`**
   - –ò–º–ø–æ—Ä—Ç —Ñ—É–Ω–∫—Ü–∏–π –∏–∑ utils.fts_search
   - –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–π –∑–∞–ø—É—Å–∫ –≤–µ–∫—Ç–æ—Ä–Ω–æ–≥–æ (similarity) –∏ –ø–æ–ª–Ω–æ—Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ (BM25) –ø–æ–∏—Å–∫–∞
   - –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –±–µ–∑ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ –ø–æ chunk_id
   - –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –º–µ—Ç—Ä–∏–∫: similarity (0-1) –∏ BM25 score –¥–ª—è —Å–æ–ø–æ—Å—Ç–∞–≤–∏–º–æ—Å—Ç–∏
   - –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏

### 10. **–û–±–Ω–æ–≤–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏—é `get_context_for_query()` –≤ `utils/vector_search.py`**
    - –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ FTS_ENABLED
    - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ hybrid_search_chunks() –≤–º–µ—Å—Ç–æ search_relevant_chunks()
    - Fallback –∫ –≤–µ–∫—Ç–æ—Ä–Ω–æ–º—É –ø–æ–∏—Å–∫—É –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö FTS

### 11. **–î–æ–±–∞–≤–∏—Ç—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é FTS5 –≤ `load_excel_to_vectordb.py`**
    - –í—ã–∑–æ–≤ populate_fts_table() –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö
    - –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏

### 12. **–°–æ–∑–¥–∞—Ç—å —É—Ç–∏–ª–∏—Ç—É `build_fts_index.py`**
    - –°–∫—Ä–∏–ø—Ç –¥–ª—è —Ä—É—á–Ω–æ–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ FTS5
    - –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
    - –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø—Ä–æ–≥—Ä–µ—Å—Å–∞

### 13. **–û–±–Ω–æ–≤–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é –≤ README.md**
    - –û–ø–∏—Å–∞–Ω–∏–µ –≥–∏–±—Ä–∏–¥–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞
    - –ù–∞—Å—Ç—Ä–æ–π–∫–∏ FTS5
    - –ö–æ–º–∞–Ω–¥—ã –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏–Ω–¥–µ–∫—Å–æ–º

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö

### –°—É—â–µ—Å—Ç–≤—É—é—â–∞—è —Ç–∞–±–ª–∏—Ü–∞ (–ù–ï –∏–∑–º–µ–Ω—è–µ—Ç—Å—è):
```sql
-- –¢–∞–±–ª–∏—Ü–∞ chunks –æ—Å—Ç–∞–µ—Ç—Å—è –∫–∞–∫ –µ—Å—Ç—å
chunks: 2306 –∑–∞–ø–∏—Å–µ–π
‚îú‚îÄ‚îÄ id (–ø–µ—Ä–≤–∏—á–Ω—ã–π –∫–ª—é—á)
‚îú‚îÄ‚îÄ chunk_id (—É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID)  
‚îú‚îÄ‚îÄ chunk_text (–¢–ï–ö–°–¢ –î–õ–Ø –ü–û–ò–°–ö–ê) ‚Üê –≠—Ç–æ –Ω—É–∂–Ω–æ FTS5!
‚îú‚îÄ‚îÄ document_id
‚îî‚îÄ‚îÄ ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø–æ–ª—è
```

### –ù–æ–≤–∞—è –≤–∏—Ä—Ç—É–∞–ª—å–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞:
```sql
-- FTS5 —Å–æ–∑–¥–∞–µ—Ç –≤–∏—Ä—Ç—É–∞–ª—å–Ω—É—é —Ç–∞–±–ª–∏—Ü—É (—Å—Å—ã–ª–∞–µ—Ç—Å—è –Ω–∞ chunks)
CREATE VIRTUAL TABLE chunks_fts USING fts5(
    chunk_id UNINDEXED,      -- –Ω–µ –∏–Ω–¥–µ–∫—Å–∏—Ä—É–µ—Ç—Å—è –¥–ª—è –ø–æ–∏—Å–∫–∞
    chunk_text,              -- –∏–Ω–¥–µ–∫—Å–∏—Ä—É–µ—Ç—Å—è –¥–ª—è –ø–æ–∏—Å–∫–∞
    content='chunks',        -- —Å—Å—ã–ª–∞–µ—Ç—Å—è –Ω–∞ —Ç–∞–±–ª–∏—Ü—É chunks
    content_rowid='id'       -- —Å–≤—è–∑—å –ø–æ –ø–æ–ª—é id
);
```

## –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—Ä–æ—Å–æ–≤

### –†–∞–∑–ª–∏—á–∏—è –≤ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∑–∞–ø—Ä–æ—Å–æ–≤:

**–ò—Å—Ö–æ–¥–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –∑–∞–ø—Ä–æ—Å**: `"–î–µ—Ñ–µ–∫—Ç—ã —Å–≤–∞—Ä–Ω—ã—Ö —à–≤–æ–≤"`

**–í–µ–∫—Ç–æ—Ä–Ω—ã–π –ø–æ–∏—Å–∫** (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π):
```python
vector_search_query = "–î–µ—Ñ–µ–∫—Ç—ã —Å–≤–∞—Ä–Ω—ã—Ö —à–≤–æ–≤"  # –ö–∞–∫ –µ—Å—Ç—å
```

**FTS5 –ø–æ–∏—Å–∫** (—Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π):
```python
fts_search_query = "–¥–µ—Ñ–µ–∫—Ç—ã* —Å–≤–∞—Ä–Ω—ã—Ö* —à–≤–æ–≤*"  # –û–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–π
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç**: –í–µ–∫—Ç–æ—Ä–Ω—ã–π –ø–æ–∏—Å–∫ –Ω–∞–π–¥–µ—Ç –ø–æ —Å–º—ã—Å–ª—É, FTS5 –Ω–∞–π–¥–µ—Ç —Ç–æ—á–Ω—ã–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è —Å –º–æ—Ä—Ñ–æ–ª–æ–≥–∏–µ–π

### –§—É–Ω–∫—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–ø—Ä–æ—Å–∞:
```python
def prepare_fts_query(query: str) -> str:
    """–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –¥–ª—è FTS5"""
    # 1. –ü—Ä–∏–≤–µ–¥–µ–Ω–∏–µ –∫ –Ω–∏–∂–Ω–µ–º—É —Ä–µ–≥–∏—Å—Ç—Ä—É
    query = query.lower()
    
    # 2. –≠–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤
    query = query.replace('"', '""').replace("'", "''")
    dangerous_chars = ['*', ':', '^', '(', ')', '[', ']']
    for char in dangerous_chars:
        query = query.replace(char, ' ')
    
    # 3. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ wildcards –¥–ª—è –º–æ—Ä—Ñ–æ–ª–æ–≥–∏–∏
    words = query.split()
    processed_words = []
    for word in words:
        if len(word) >= 4:  # –¢–æ–ª—å–∫–æ –¥–ª—è –¥–ª–∏–Ω–Ω—ã—Ö —Å–ª–æ–≤
            processed_words.append(f"{word}*")
        else:
            processed_words.append(word)
    
    return " ".join(processed_words)
```

## –ì–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–∏—Å–∫

### –ü—Ä–∏–Ω—Ü–∏–ø —Ä–∞–±–æ—Ç—ã:
```python
def hybrid_search_chunks(query, vector_store, conn, vector_top_k=3, fts_top_k=3):
    # 1. –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–π –ø–æ–∏—Å–∫
    vector_chunks = search_relevant_chunks(query, vector_store, conn, vector_top_k)
    # vector_chunks —Å–æ–¥–µ—Ä–∂–∞—Ç –ø–æ–ª–µ 'similarity' (0-1, –±–æ–ª—å—à–µ = –ª—É—á—à–µ)
    
    fts_chunks = search_fts_chunks(query, conn, fts_top_k)
    # fts_chunks —Å–æ–¥–µ—Ä–∂–∞—Ç –ø–æ–ª–µ 'bm25_score' (–≤—ã—à–µ = –ª—É—á—à–µ)
    
    # 2. –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –º–µ—Ç—Ä–∏–∫ –¥–ª—è —Å–æ–ø–æ—Å—Ç–∞–≤–∏–º–æ—Å—Ç–∏
    normalized_chunks = normalize_relevance_scores(vector_chunks, fts_chunks)
    
    # 3. –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –±–µ–∑ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
    combined_chunks = merge_results(normalized_chunks['vector'], normalized_chunks['fts'])
    
    # 4. –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏
    return sort_by_combined_relevance(combined_chunks)
```

### –û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã:
- **–î–æ 6 —á–∞–Ω–∫–æ–≤**: 3 –≤–µ–∫—Ç–æ—Ä–Ω—ã—Ö + 3 FTS5 (–±–µ–∑ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤)
- **–õ—É—á—à–µ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ**: —Å–µ–º–∞–Ω—Ç–∏–∫–∞ (similarity) + —Ç–æ—á–Ω—ã–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è (BM25)
- **Fallback**: –ø—Ä–∏ –æ—à–∏–±–∫–µ FTS5 –æ—Å—Ç–∞–µ—Ç—Å—è –≤–µ–∫—Ç–æ—Ä–Ω—ã–π –ø–æ–∏—Å–∫
- **–ú–µ—Ç—Ä–∏–∫–∏**: –µ–¥–∏–Ω–∞—è –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –æ—Ü–µ–Ω–∫–∞ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏

### –ü—Ä–∏–º–µ—Ä –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤:
```python
# –ó–∞–ø—Ä–æ—Å: "–¥–µ—Ñ–µ–∫—Ç—ã —Å–≤–∞—Ä–Ω—ã—Ö —à–≤–æ–≤"

# –í–µ–∫—Ç–æ—Ä–Ω—ã–π –ø–æ–∏—Å–∫ (–∫–æ—Å–∏–Ω—É—Å–Ω–æ–µ —Å—Ö–æ–¥—Å—Ç–≤–æ):
vector_results = [
    {'chunk_id': '123', 'similarity': 0.856, 'source': 'vector'},
    {'chunk_id': '456', 'similarity': 0.834, 'source': 'vector'},
    {'chunk_id': '789', 'similarity': 0.812, 'source': 'vector'}
]

# FTS5 –ø–æ–∏—Å–∫ (BM25):
fts_results = [
    {'chunk_id': '123', 'bm25_score': 8.95, 'source': 'fts'},  # –¥—É–±–ª–∏–∫–∞—Ç
    {'chunk_id': '234', 'bm25_score': 7.23, 'source': 'fts'},  # –Ω–æ–≤—ã–π
    {'chunk_id': '567', 'bm25_score': 6.81, 'source': 'fts'}   # –Ω–æ–≤—ã–π
]

# –û–±—ä–µ–¥–∏–Ω–µ–Ω–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç (–±–µ–∑ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤):
combined_results = [
    {'chunk_id': '123', 'similarity': 0.856, 'bm25_score': 8.95, 'combined_score': 0.92},
    {'chunk_id': '456', 'similarity': 0.834, 'combined_score': 0.83},
    {'chunk_id': '234', 'bm25_score': 7.23, 'combined_score': 0.79},
    {'chunk_id': '789', 'similarity': 0.812, 'combined_score': 0.81},
    {'chunk_id': '567', 'bm25_score': 6.81, 'combined_score': 0.76}
]
```

## –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

- **–°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å**: –†–µ–∑—É–ª—å—Ç–∞—Ç—ã FTS5 –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤ —Ç–æ–º –∂–µ —Ñ–æ—Ä–º–∞—Ç–µ, —á—Ç–æ –∏ –≤–µ–∫—Ç–æ—Ä–Ω—ã–µ (—Å –ø–æ–ª–µ–º 'similarity')
- **–û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—Ä–æ—Å–æ–≤**: –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –¢–û–õ–¨–ö–û –¥–ª—è FTS5 –ø–æ–∏—Å–∫–∞
- **–í–µ–∫—Ç–æ—Ä–Ω—ã–π –ø–æ–∏—Å–∫**: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –∑–∞–ø—Ä–æ—Å –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –≤ –≤–µ–∫—Ç–æ—Ä–Ω—ã–π –ø–æ–∏—Å–∫ –ë–ï–ó –∏–∑–º–µ–Ω–µ–Ω–∏–π
- **–ú–µ—Ç—Ä–∏–∫–∏**: –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è BM25 score –∫ –¥–∏–∞–ø–∞–∑–æ–Ω—É [0,1] –¥–ª—è —Å–æ–ø–æ—Å—Ç–∞–≤–∏–º–æ—Å—Ç–∏ —Å cosine similarity
- **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**: –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- **–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å**: Graceful degradation –ø—Ä–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ FTS5
- **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ**: –ü–æ–¥—Ä–æ–±–Ω—ã–µ –ª–æ–≥–∏ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

## –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

1. **–°–æ–∑–¥–∞—Ç—å –º–æ–¥—É–ª—å** `utils/fts_search.py`
2. **–î–æ–±–∞–≤–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏** –≤ `config.py`
3. **–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å FTS5**: `python build_fts_index.py`
4. **–û–±–Ω–æ–≤–∏—Ç—å –≤–µ–∫—Ç–æ—Ä–Ω—ã–π –ø–æ–∏—Å–∫** –¥–ª—è –≥–∏–±—Ä–∏–¥–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞
5. **–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å**: —Å—Ä–∞–≤–Ω–∏—Ç—å –∫–∞—á–µ—Å—Ç–≤–æ –ø–æ–∏—Å–∫–∞
6. **–û–±–Ω–æ–≤–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é**

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

- –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç—ã –≤ `test_fts_search.py`
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç—É —Å —Ä—É—Å—Å–∫–∏–º–∏ —Ç–µ–∫—Å—Ç–∞–º–∏
- –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –Ω–∞ –±–æ–ª—å—à–∏—Ö –æ–±—ä–µ–º–∞—Ö
- –°—Ä–∞–≤–Ω–∏—Ç—å —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å —Å –≤–µ–∫—Ç–æ—Ä–Ω—ã–º –ø–æ–∏—Å–∫–æ–º
- –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤ –≤ –∑–∞–ø—Ä–æ—Å–∞—Ö

## –û–∂–∏–¥–∞–µ–º—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

- **–ü–æ–ª–Ω–æ—Ç–∞ –ø–æ–∏—Å–∫–∞**: –Ω–∞—Ö–æ–¥–∏—Ç –∏ —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏ –ø–æ—Ö–æ–∂–∏–µ, –∏ —Ç–æ—á–Ω—ã–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è
- **–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å**: —Å–Ω–∏–∂–∞–µ—Ç —Ä–∏—Å–∫ –ø—Ä–æ–ø—É—Å–∫–∞ –≤–∞–∂–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
- **–ì–∏–±–∫–æ—Å—Ç—å**: —Ä–∞–±–æ—Ç–∞–µ—Ç —Å —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–º–∏ —Ç–µ—Ä–º–∏–Ω–∞–º–∏ –∏ –Ω–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–º–∏ —Å—Å—ã–ª–∫–∞–º–∏
- **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**: FTS5 —Ä–∞–±–æ—Ç–∞–µ—Ç –±—ã—Å—Ç—Ä–µ–µ –≤–µ–∫—Ç–æ—Ä–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞

–≠—Ç–æ—Ç –ø–ª–∞–Ω –æ–±–µ—Å–ø–µ—á–∏—Ç —Å–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª–Ω–æ—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–≥–æ –º–æ–¥—É–ª—è –ø–æ–ª–Ω–æ—Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –ø–æ–∏—Å–∫–∞, –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç –≤–µ–∫—Ç–æ—Ä–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞, –Ω–æ –ª–µ–≥–∫–æ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è —Å –Ω–∏–º –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –≥–∏–±—Ä–∏–¥–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã! üöÄ 