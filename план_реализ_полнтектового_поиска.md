# –ü–ª–∞–Ω —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –ø–æ–ª–Ω–æ—Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –ø–æ–∏—Å–∫–∞ (FTS5) - –ù–ï–ó–ê–í–ò–°–ò–ú–ê–Ø –í–ï–†–°–ò–Ø

## –¶–µ–ª—å: –î–æ–±–∞–≤–∏—Ç—å FTS5 –∫–∞–∫ –æ—Ç–¥–µ–ª—å–Ω—É—é —Å–∏—Å—Ç–µ–º—É, –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—É—é –≤–µ–∫—Ç–æ—Ä–Ω–æ–º—É –ø–æ–∏—Å–∫—É

## üìã IMPLEMENTATION CHECKLIST:

### 1. **–°–æ–∑–¥–∞–Ω–∏–µ –æ—Ç–¥–µ–ª—å–Ω–æ–≥–æ FTS –∏–Ω–¥–µ–∫—Å–∞**
- –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç `build_fts_index.py` (–∞–Ω–∞–ª–æ–≥ `build_faiss_index.py`)
- –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π `knowledge_base_v2.db`
- –°–æ–∑–¥–∞—Ç—å FTS —Ç–∞–±–ª–∏—Ü—É, —á–∏—Ç–∞—è –∏–∑ –≥–æ—Ç–æ–≤–æ–π —Ç–∞–±–ª–∏—Ü—ã `chunks`

### 2. **–°–æ–∑–¥–∞–Ω–∏–µ –º–æ–¥—É–ª—è FTS –ø–æ–∏—Å–∫–∞**
- –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π —Ñ–∞–π–ª `utils/fts_search.py` —Å —Ñ—É–Ω–∫—Ü–∏—è–º–∏:
  - `fts_search(query, limit=3)` - –ø–æ–∏—Å–∫ –ø–æ FTS5
  - `merge_results(vec_ids, fts_rows)` - –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –±–µ–∑ –¥—É–±–ª–µ–π
  - `hybrid_search(query, top_k=3)` - –≥–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–∏—Å–∫

### 3. **–°–æ–∑–¥–∞–Ω–∏–µ –≥–∏–±—Ä–∏–¥–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞**
- –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π —Ñ–∞–π–ª `utils/hybrid_search.py` —Å —Ñ—É–Ω–∫—Ü–∏–µ–π:
  - `get_hybrid_context(query, vector_store, conn, top_k=3)` - –æ–±—ä–µ–¥–∏–Ω–µ–Ω–Ω—ã–π –ø–æ–∏—Å–∫
  - –§—É–Ω–∫—Ü–∏—è –≤—ã–∑—ã–≤–∞–µ—Ç –û–ë–ï —Å–∏—Å—Ç–µ–º—ã –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ –∏ —Å–∫–ª–µ–∏–≤–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

### 4. **–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ –±–æ—Ç–∞**
- –î–æ–±–∞–≤–∏—Ç—å –æ–¥–∏–Ω –∏–º–ø–æ—Ä—Ç –≤ `bot.py`
- –ó–∞–º–µ–Ω–∏—Ç—å –û–î–ò–ù –≤—ã–∑–æ–≤ `get_context_for_query` –Ω–∞ `get_hybrid_context`
- –í–µ–∫—Ç–æ—Ä–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –æ—Å—Ç–∞–µ—Ç—Å—è –Ω–µ—Ç—Ä–æ–Ω—É—Ç–æ–π

### 5. **–°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤**
- –°–æ–∑–¥–∞—Ç—å `test_fts_search.py` –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è FTS –ø–æ–∏—Å–∫–∞
- –°–æ–∑–¥–∞—Ç—å `test_hybrid_search.py` –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≥–∏–±—Ä–∏–¥–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞
- –í—Å–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ç–µ—Å—Ç—ã –æ—Å—Ç–∞—é—Ç—Å—è —Ä–∞–±–æ—Ç–∞—Ç—å

### 6. **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —É—Ç–∏–ª–∏—Ç**
- –°–æ–∑–¥–∞—Ç—å `check_fts_db.py` –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ FTS –∏–Ω–¥–µ–∫—Å–∞
- –î–æ–±–∞–≤–∏—Ç—å FTS —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π `check_db.py` (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

### 7. **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è**
- –°–æ–∑–¥–∞—Ç—å `FTS_SETUP.md` —Å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º–∏ –ø–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ
- –û–±–Ω–æ–≤–∏—Ç—å `README.md` —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º –≥–∏–±—Ä–∏–¥–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞

### 8. **–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è**
- –î–æ–±–∞–≤–∏—Ç—å FTS –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –≤ `config.py`
- –î–æ–±–∞–≤–∏—Ç—å —Ñ–ª–∞–≥ –≤–∫–ª—é—á–µ–Ω–∏—è/–≤—ã–∫–ª—é—á–µ–Ω–∏—è FTS

### 9. **–§–∏–Ω–∞–ª—å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ**
- –ü—Ä–æ–≤–µ—Å—Ç–∏ —Å—Ä–∞–≤–Ω–∏—Ç–µ–ª—å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (–≤–µ–∫—Ç–æ—Ä–Ω—ã–π vs FTS vs –≥–∏–±—Ä–∏–¥–Ω—ã–π)
- –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –≤–µ–∫—Ç–æ—Ä–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ –ø—Ä–µ–∂–¥–µ

## üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏:

### –®–∞–≥ 1: `build_fts_index.py`
```python
def create_fts_index():
    """–°–æ–∑–¥–∞–µ—Ç FTS –∏–Ω–¥–µ–∫—Å –∏–∑ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π —Ç–∞–±–ª–∏—Ü—ã chunks"""
    conn = sqlite3.connect('knowledge_base_v2.db')
    cursor = conn.cursor()
    
    # –°–æ–∑–¥–∞–µ–º FTS —Ç–∞–±–ª–∏—Ü—É
    cursor.execute('''
        CREATE VIRTUAL TABLE IF NOT EXISTS chunks_fts USING fts5(
            chunk_text,
            content='chunks',
            content_rowid='id',
            tokenize="unicode61 remove_diacritics 2"
        );
    ''')
    
    # –ó–∞–ø–æ–ª–Ω—è–µ–º FTS –∏–Ω–¥–µ–∫—Å –∏–∑ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö
    cursor.execute("INSERT INTO chunks_fts(chunks_fts) VALUES('rebuild');")
    
    # –û–ø—Ç–∏–º–∏–∑–∏—Ä—É–µ–º
    cursor.execute("INSERT INTO chunks_fts(chunks_fts) VALUES('optimize');")
    
    conn.commit()
    conn.close()
```

### –®–∞–≥ 2: `utils/fts_search.py`
```python
async def fts_search(query: str, limit: int = 3) -> List[Dict]:
    """–ü–æ–∏—Å–∫ –ø–æ FTS5 - –ù–ï –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –≤–µ–∫—Ç–æ—Ä–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞"""
    conn = sqlite3.connect('knowledge_base_v2.db')
    cursor = conn.cursor()
    
    sql = """
    SELECT chunks.* FROM chunks_fts
    JOIN chunks ON chunks.id = chunks_fts.rowid
    WHERE chunks_fts MATCH ?
    ORDER BY bm25(chunks_fts)
    LIMIT ?
    """
    
    cursor.execute(sql, (query, limit))
    results = cursor.fetchall()
    conn.close()
    
    return results
```

### –®–∞–≥ 3: `utils/hybrid_search.py`
```python
async def get_hybrid_context(query: str, vector_store, conn, top_k: int = 3) -> str:
    """–û–±—ä–µ–¥–∏–Ω–µ–Ω–Ω—ã–π –ø–æ–∏—Å–∫ - –ù–ï —Ç—Ä–æ–≥–∞–µ—Ç –≤–µ–∫—Ç–æ—Ä–Ω—É—é —Å–∏—Å—Ç–µ–º—É"""
    
    # 1. –í–µ–∫—Ç–æ—Ä–Ω—ã–π –ø–æ–∏—Å–∫ (—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥)
    vec_results = search_relevant_chunks(query, vector_store, conn, top_k)
    vec_ids = [chunk['id'] for chunk in vec_results]
    
    # 2. FTS –ø–æ–∏—Å–∫ (–Ω–æ–≤—ã–π –∫–æ–¥)
    fts_results = await fts_search(query, limit=top_k)
    
    # 3. –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –±–µ–∑ –¥—É–±–ª–µ–π
    merged_ids = merge_results(vec_ids, fts_results)
    
    # 4. –ü–æ–ª—É—á–µ–Ω–∏–µ —Ñ–∏–Ω–∞–ª—å–Ω—ã—Ö —á–∞–Ω–∫–æ–≤
    final_chunks = get_chunks_by_ids(conn, merged_ids)
    
    # 5. –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ (–∫–∞–∫ –≤ –≤–µ–∫—Ç–æ—Ä–Ω–æ–π —Å–∏—Å—Ç–µ–º–µ)
    return format_context(final_chunks)
```

### –®–∞–≥ 4: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ `bot.py`
```python
# –ë–´–õ–û:
# from utils.vector_search import get_context_for_query
# knowledge_context = get_context_for_query(user_query, vector_store, conn)

# –°–¢–ê–õ–û:
from utils.hybrid_search import get_hybrid_context
knowledge_context = await get_hybrid_context(user_query, vector_store, conn)
```

## ‚úÖ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ —Ç–∞–∫–æ–≥–æ –ø–æ–¥—Ö–æ–¥–∞:

1. **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å**: –í–µ–∫—Ç–æ—Ä–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –æ—Å—Ç–∞–µ—Ç—Å—è –Ω–µ—Ç—Ä–æ–Ω—É—Ç–æ–π
2. **–ù–µ–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å**: FTS –º–æ–∂–Ω–æ –≤–∫–ª—é—á–∞—Ç—å/–≤—ã–∫–ª—é—á–∞—Ç—å
3. **–ü—Ä–æ—Å—Ç–æ—Ç–∞**: –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∫–æ–¥–µ
4. **–¢–µ—Å—Ç–∏—Ä—É–µ–º–æ—Å—Ç—å**: –õ–µ–≥–∫–æ —Å—Ä–∞–≤–Ω–∏–≤–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
5. **–û—Ç–∫–∞—Ç**: –ú–æ–∂–Ω–æ –±—ã—Å—Ç—Ä–æ –≤–µ—Ä–Ω—É—Ç—å—Å—è –∫ –≤–µ–∫—Ç–æ—Ä–Ω–æ–º—É –ø–æ–∏—Å–∫—É

## üèóÔ∏è –§–∞–π–ª–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞:

```
–ù–æ–≤—ã–µ —Ñ–∞–π–ª—ã:
‚îú‚îÄ‚îÄ build_fts_index.py           # –°–æ–∑–¥–∞–Ω–∏–µ FTS –∏–Ω–¥–µ–∫—Å–∞
‚îú‚îÄ‚îÄ utils/fts_search.py          # FTS –ø–æ–∏—Å–∫
‚îú‚îÄ‚îÄ utils/hybrid_search.py       # –ì–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–∏—Å–∫
‚îú‚îÄ‚îÄ test_fts_search.py           # –¢–µ—Å—Ç—ã FTS
‚îú‚îÄ‚îÄ test_hybrid_search.py        # –¢–µ—Å—Ç—ã –≥–∏–±—Ä–∏–¥–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞
‚îî‚îÄ‚îÄ check_fts_db.py             # –ü—Ä–æ–≤–µ—Ä–∫–∞ FTS

–ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ñ–∞–π–ª–∞—Ö:
‚îú‚îÄ‚îÄ bot.py                       # 2 —Å—Ç—Ä–æ–∫–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π
‚îú‚îÄ‚îÄ config.py                    # –î–æ–±–∞–≤–∏—Ç—å FTS –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
‚îî‚îÄ‚îÄ README.md                    # –û–±–Ω–æ–≤–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é
```

