# üìù –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–æ–ª–Ω–æ—Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –ø–æ–∏—Å–∫–∞ (FTS5)

## üìã –û–±–∑–æ—Ä

–≠—Ç–æ—Ç –≥–∞–π–¥ –ø–æ–º–æ–∂–µ—Ç –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –ø–æ–ª–Ω–æ—Ç–µ–∫—Å—Ç–æ–≤—ã–π –ø–æ–∏—Å–∫ FTS5 –¥–ª—è —Ä–∞–±–æ—Ç—ã –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ —Å –≤–µ–∫—Ç–æ—Ä–Ω—ã–º –ø–æ–∏—Å–∫–æ–º –≤ Telegram –±–æ—Ç–µ.

## üîç –ß—Ç–æ —Ç–∞–∫–æ–µ FTS5?

FTS5 (Full-Text Search) - —ç—Ç–æ –≤—Å—Ç—Ä–æ–µ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –ø–æ–ª–Ω–æ—Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –ø–æ–∏—Å–∫–∞ SQLite, –∫–æ—Ç–æ—Ä–∞—è:
- ‚úÖ –ù–∞—Ö–æ–¥–∏—Ç —Ç–æ—á–Ω—ã–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è —Å–ª–æ–≤ –∏ —Ñ—Ä–∞–∑
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ä—É—Å—Å–∫–∏–π —è–∑—ã–∫ —á–µ—Ä–µ–∑ tokenizer unicode61
- ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç –±—ã—Å—Ç—Ä–æ (< 5 –º—Å –Ω–∞ ~100,000 –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤)
- ‚úÖ –ù–µ —Ç—Ä–µ–±—É–µ—Ç –≤–Ω–µ—à–Ω–∏—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

## üöÄ –ë—ã—Å—Ç—Ä–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞

### –®–∞–≥ 1: –°–æ–∑–¥–∞–Ω–∏–µ FTS –∏–Ω–¥–µ–∫—Å–∞

```bash
# –°–æ–∑–¥–∞–µ–º FTS –∏–Ω–¥–µ–∫—Å –∏–∑ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö
python build_fts_index.py
```

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**
- ‚úÖ –°–æ–∑–¥–∞–µ—Ç—Å—è FTS5 –≤–∏—Ä—Ç—É–∞–ª—å–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ `chunks_fts`
- ‚úÖ –ò–Ω–¥–µ–∫—Å–∏—Ä—É—é—Ç—Å—è –≤—Å–µ —Ç–µ–∫—Å—Ç—ã –∏–∑ —Ç–∞–±–ª–∏—Ü—ã `chunks`
- ‚úÖ –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è —Ç–æ–∫–µ–Ω–∏–∑–∞—Ü–∏—è –¥–ª—è —Ä—É—Å—Å–∫–æ–≥–æ —è–∑—ã–∫–∞
- ‚úÖ –û–ø—Ç–∏–º–∏–∑–∏—Ä—É–µ—Ç—Å—è –∏–Ω–¥–µ–∫—Å –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞

### –®–∞–≥ 2: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ FTS –ø–æ–∏—Å–∫–∞

```bash
# –¢–µ—Å—Ç–∏—Ä—É–µ–º FTS –ø–æ–∏—Å–∫
python test_fts_search.py
```

### –®–∞–≥ 3: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≥–∏–±—Ä–∏–¥–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞

```bash
# –¢–µ—Å—Ç–∏—Ä—É–µ–º –≥–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–∏—Å–∫ (FTS + –≤–µ–∫—Ç–æ—Ä–Ω—ã–π)
python test_hybrid_search.py
```

## üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ FTS —Ç–∞–±–ª–∏—Ü—ã

```sql
CREATE VIRTUAL TABLE chunks_fts USING fts5(
    chunk_text,                              -- –ü–æ–ª–µ –¥–ª—è –ø–æ–∏—Å–∫–∞
    content='chunks',                        -- –ò—Å—Ç–æ—á–Ω–∏–∫ –¥–∞–Ω–Ω—ã—Ö
    content_rowid='id',                      -- –°–≤—è–∑—å —Å –æ—Å–Ω–æ–≤–Ω–æ–π —Ç–∞–±–ª–∏—Ü–µ–π
    tokenize="unicode61 remove_diacritics 2" -- –¢–æ–∫–µ–Ω–∏–∑–∞—Ü–∏—è –¥–ª—è —Ä—É—Å—Å–∫–æ–≥–æ —è–∑—ã–∫–∞
);
```

### –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –≥–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–∏—Å–∫

```mermaid
graph LR
    A[–ó–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è] --> B[–í–µ–∫—Ç–æ—Ä–Ω—ã–π –ø–æ–∏—Å–∫]
    A --> C[FTS –ø–æ–∏—Å–∫]
    B --> D[–¢–æ–ø-3 —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞]
    C --> E[–¢–æ–ø-3 —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞]
    D --> F[–û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –±–µ–∑ –¥—É–±–ª–µ–π]
    E --> F
    F --> G[–î–æ 6 —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤]
    G --> H[–ö–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è GPT]
```

## üìä –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ç–∏–ø–æ–≤ –ø–æ–∏—Å–∫–∞

| –¢–∏–ø –ø–æ–∏—Å–∫–∞ | –õ—É—á—à–µ –¥–ª—è | –ü—Ä–∏–º–µ—Ä –∑–∞–ø—Ä–æ—Å–∞ |
|------------|-----------|----------------|
| **–í–µ–∫—Ç–æ—Ä–Ω—ã–π** | –°–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–∏—Å–∫ | "–ø—Ä–æ–±–ª–µ–º—ã —Å —Å–µ—Ä–¥—Ü–µ–º" |
| **FTS** | –¢–æ—á–Ω—ã–µ —Ç–µ—Ä–º–∏–Ω—ã | "–≥–∏–ø–µ—Ä—Ç–æ–Ω–∏—è", "–ì–û–°–¢-123" |
| **–ì–∏–±—Ä–∏–¥–Ω—ã–π** | –ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π | "–¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –≥–∏–ø–µ—Ä—Ç–æ–Ω–∏–∏" |

## üéØ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤

### –í —Ñ–∞–π–ª–µ `config.py`:

```python
# FTS search configuration
FTS_ENABLED = True                    # –í–∫–ª—é—á–µ–Ω–∏–µ/–≤—ã–∫–ª—é—á–µ–Ω–∏–µ FTS –ø–æ–∏—Å–∫–∞
FTS_DEFAULT_LIMIT = 3                # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ FTS –ø–æ–∏—Å–∫–∞
HYBRID_SEARCH_ENABLED = True         # –í–∫–ª—é—á–µ–Ω–∏–µ –≥–∏–±—Ä–∏–¥–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞
```

### –í–æ–∑–º–æ–∂–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è:

- `FTS_ENABLED = False` - –æ—Ç–∫–ª—é—á–∏—Ç—å FTS, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –≤–µ–∫—Ç–æ—Ä–Ω—ã–π –ø–æ–∏—Å–∫
- `FTS_DEFAULT_LIMIT = 5` - –ø–æ–ª—É—á–∞—Ç—å –±–æ–ª—å—à–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –æ—Ç FTS
- `HYBRID_SEARCH_ENABLED = False` - –æ—Ç–∫–ª—é—á–∏—Ç—å –≥–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–∏—Å–∫

## üìà –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –æ—Ç–ª–∞–¥–∫–∞

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ FTS –∏–Ω–¥–µ–∫—Å–∞:

```python
from utils.fts_search import get_fts_statistics

stats = get_fts_statistics()
print(f"FTS —Ç–∞–±–ª–∏—Ü–∞ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç: {stats['fts_table_exists']}")
print(f"–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π: {stats['total_records']}")
```

### –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:

FTS –ø–æ–∏—Å–∫ –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è –≤ –º–æ–¥—É–ª–µ `fts_search`:
```python
fts_logger.info(f"FTS –ø–æ–∏—Å–∫ –ø–æ –∑–∞–ø—Ä–æ—Å—É '{query}' –Ω–∞—à–µ–ª {len(results)} —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤")
```

–ì–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–∏—Å–∫ –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è –≤ –º–æ–¥—É–ª–µ `hybrid_search`:
```python
hybrid_logger.info(f"–û–±—ä–µ–¥–∏–Ω–µ–Ω–æ {len(merged_results)} —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤")
```

## üîç –°–∏–Ω—Ç–∞–∫—Å–∏—Å FTS –∑–∞–ø—Ä–æ—Å–æ–≤
"–¥–µ—Ñ–µ–∫—Ç—ã —Å–≤–∞—Ä–Ω—ã—Ö —à–≤–æ–≤",
        "—É–ª—å—Ç—Ä–∞–∑–≤—É–∫–æ–≤–æ–π –∫–æ–Ω—Ç—Ä–æ–ª—å",
        "—Ä–µ–Ω—Ç–≥–µ–Ω–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–π –∫–æ–Ω—Ç—Ä–æ–ª—å"

### –û—Å–Ω–æ–≤–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:

```python
# –ü—Ä–æ—Å—Ç–æ–π –ø–æ–∏—Å–∫
fts_search("–¥–µ—Ñ–µ–∫—Ç—ã —Å–≤–∞—Ä–Ω—ã—Ö —à–≤–æ–≤")

# –ü–æ–∏—Å–∫ —Ñ—Ä–∞–∑—ã
fts_search('"—É–ª—å—Ç—Ä–∞–∑–≤—É–∫–æ–≤–æ–π –∫–æ–Ω—Ç—Ä–æ–ª—å"')

# –ü–æ–∏—Å–∫ —Å –ø—Ä–µ—Ñ–∏–∫—Å–æ–º
fts_search("–¥–∏–∞–≥–Ω–æ—Å—Ç*")

# –ü–æ–∏—Å–∫ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Å–ª–æ–≤
fts_search("—Ä–µ–Ω—Ç–≥–µ–Ω–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–π –∫–æ–Ω—Ç—Ä–æ–ª—å")

```

## üö® –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –Ω–µ–ø–æ–ª–∞–¥–æ–∫

### –ü—Ä–æ–±–ª–µ–º–∞: FTS —Ç–∞–±–ª–∏—Ü–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞

**–†–µ—à–µ–Ω–∏–µ:**
```bash
python build_fts_index.py
```

### –ü—Ä–æ–±–ª–µ–º–∞: –ü—É—Å—Ç—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã FTS –ø–æ–∏—Å–∫–∞

**–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞:**
```python
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∑–∞–ø–∏—Å–µ–π
import sqlite3
conn = sqlite3.connect('knowledge_base_v2.db')
cursor = conn.cursor()
cursor.execute("SELECT COUNT(*) FROM chunks_fts")
print(f"–ó–∞–ø–∏—Å–µ–π –≤ FTS: {cursor.fetchone()[0]}")
```

**–†–µ—à–µ–Ω–∏–µ:**
```bash
# –ü–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–∞
python build_fts_index.py
```

### –ü—Ä–æ–±–ª–µ–º–∞: –ú–µ–¥–ª–µ–Ω–Ω—ã–π –ø–æ–∏—Å–∫

**–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è:**
```sql
-- –ó–∞–ø—É—Å—Ç–∏—Ç—å –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—é –∏–Ω–¥–µ–∫—Å–∞
INSERT INTO chunks_fts(chunks_fts) VALUES('optimize');
```

## üéõÔ∏è –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

### –ú–æ—Ä—Ñ–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –ø–æ–∏—Å–∫

–î–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ —Ä–∞–∑–Ω—ã–º —Ñ–æ—Ä–º–∞–º —Å–ª–æ–≤–∞ (–ª–µ—á–µ–Ω–∏–µ/–ª–µ—á–∏—Ç—å/–ª–µ—á–∏–ª):

1. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ pymorphy2:
```bash
pip install pymorphy2
```

2. –°–æ–∑–¥–∞–π—Ç–µ –ø–æ–ª–µ —Å–æ —Å—Ç–µ–º–º–∏–Ω–≥–æ–º:
```sql
ALTER TABLE chunks ADD COLUMN stemmed_text TEXT;
```

3. –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª–µ —Å—Ç–µ–º–º–∞–º–∏ –∏ —Å–æ–∑–¥–∞–π—Ç–µ FTS –∏–Ω–¥–µ–∫—Å –ø–æ –Ω–µ–º—É.

### –ü–æ–∏—Å–∫ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤

```python
# –ü–æ–∏—Å–∫ —Ç–æ–ª—å–∫–æ –≤ –∫–ª–∏–Ω–∏—á–µ—Å–∫–∏—Ö —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è—Ö
def fts_search_by_category(query, doc_type):
    sql = """
    SELECT chunks.* FROM chunks_fts
    JOIN chunks ON chunks.id = chunks_fts.rowid
    WHERE chunks_fts MATCH ? AND chunks.doc_type_short = ?
    """
    # ... –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞
```

## üìö –ü–æ–ª–µ–∑–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã

- [SQLite FTS5 Documentation](https://sqlite.org/fts5.html)
- [FTS5 Query Syntax](https://sqlite.org/fts5.html#fts5_query_syntax)
- [Unicode61 Tokenizer](https://sqlite.org/fts5.html#unicode61_tokenizer)

## ‚úÖ –ß–µ–∫-–ª–∏—Å—Ç –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏

–ü–æ—Å–ª–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ:

- [ ] `python build_fts_index.py` –≤—ã–ø–æ–ª–Ω–∏–ª—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫
- [ ] `python test_fts_search.py` –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞
- [ ] `python test_hybrid_search.py` –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –æ–±—ä–µ–¥–∏–Ω–µ–Ω–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
- [ ] –í –ª–æ–≥–∞—Ö –±–æ—Ç–∞ –µ—Å—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –æ –≥–∏–±—Ä–∏–¥–Ω–æ–º –ø–æ–∏—Å–∫–µ
- [ ] –ë–æ—Ç –æ—Ç–≤–µ—á–∞–µ—Ç —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º FTS –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞

üéâ **–ì–æ—Ç–æ–≤–æ!** –í–∞—à –±–æ—Ç —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –≥–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–∏—Å–∫! 