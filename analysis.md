# Анализ проекта и план реализации Telegram-бота "Диагност ПБ"

## 1. Текущее состояние проекта

### 1.1. Общая архитектура

- Telegram-бот реализован на Python с использованием библиотеки aiogram 3.17.0
- Интеграция с OpenAI API для генерации ответов (модель по умолчанию: gpt-4.1-nano)
- Архитектура включает модули для обработки сообщений, управления состоянием, логирования и подсчета токенов

### 1.2. Существующие компоненты

- **bot.py**: Основной файл с обработчиками команд и сообщений
- **prompts.py**: Системные промпты и инструкции для модели
- **utils/**: Вспомогательные модули
  - **keyboards.py**: Создание и управление встроенными клавиатурами
  - **logger.py**: Система логирования событий
  - **token_counter.py**: Подсчет использования токенов OpenAI
  - **exceptions.py**: Обработка исключений

### 1.3. Текущий функционал бота

- Обработка базовых команд (/start, /cancel)
- Поддержка диалога с пользователем по темам неразрушающего контроля
- Переформулирование пользовательских вопросов в технический формат
- Кнопки быстрого доступа ("Объясни", "Новый вопрос")
- Индикация набора текста во время генерации ответа
- Логирование действий пользователя и ответов бота

## 2. Требования заказчика (ВДГБ:ИТС, Росгазификация)

### 2.1. Цель проекта

Разработка Telegram-бота с AI-ассистентом для специалистов по неразрушающему контролю (НК), обеспечивающего быстрый доступ к актуальным нормативным документам.

### 2.2. Ключевые задачи

- Сбор и обработка нормативных документов с сайта diagnostpb.ru
- Создание базы знаний с применением Embedding и LangChain
- Разработка диалоговой модели на основе GPT для поиска по нормативам
- Оптимизация обработки текстов и сокращение потребления токенов
- Интеграция в Telegram-бот с возможностью обновления данных

### 2.3. Ожидаемые результаты

- Сокращение времени поиска нормативных требований
- Снижение нагрузки на экспертов за счёт автоматизации ответов на типовые запросы
- Уменьшение вероятности ошибок при интерпретации документов
- Ускорение цифровизации отрасли и повышение квалификации специалистов

## 3. План изменений и доработок

### 3.1. Архитектурные изменения

- Добавление модуля для работы с базой знаний нормативных документов
- Интеграция с библиотекой LangChain для обработки документов
- Внедрение механизма RAG (Retrieval-Augmented Generation) для обогащения ответов информацией из нормативов
- Создание системы кэширования для оптимизации использования токенов

### 3.2. Новые компоненты

- **document_scraper.py**: Модуль для сбора и обработки нормативных документов с сайта diagnostpb.ru
- **embedding_manager.py**: Создание и управление векторными представлениями документов
- **knowledge_base.py**: Управление базой знаний и поисковыми запросами
- **document_updater.py**: Система для обновления базы нормативных документов
- **rag_engine.py**: Компонент для обогащения ответов на основе релевантных документов

### 3.3. Модификации существующих компонентов

- **bot.py**:

  - Интеграция с базой знаний
  - Добавление обработчиков для поиска по нормативным документам
  - Модификация системы генерации ответов для использования RAG
  - Оптимизация потребления токенов
- **prompts.py**:

  - Обновление системных промптов для работы с нормативной базой
  - Добавление инструкций по цитированию нормативных документов
  - Разработка специализированных промптов для различных методов НК
- **keyboards.py**:

  - Добавление кнопок для выбора типов нормативных документов
  - Создание клавиатуры для выбора методов НК
  - Кнопки для уточнения поисковых запросов

### 3.4. Дополнения в технологический стек

- **langchain**: Для работы с документами и RAG
- **FAISS/Chroma**: Для векторного поиска
- **beautifulsoup4/scrapy**: Для парсинга нормативных документов
- **tiktoken**: Для оптимизации использования токенов

## 4. Поэтапный план реализации

### Этап 1: Подготовка и сбор данных

1. Разработка скрапера для сбора нормативных документов с diagnostpb.ru
2. Создание системы для структурирования и нормализации текстов документов
3. Формирование базовой структуры базы знаний

### Этап 2: Создание базы знаний

1. Реализация модуля для создания эмбеддингов документов
2. Создание компонента для хранения и поиска по векторной базе данных
3. Разработка интерфейса для работы с базой знаний

### Этап 3: Интеграция с текущим ботом

1. Модификация обработчиков сообщений для работы с базой знаний
2. Обновление промптов и инструкций для модели
3. Создание механизма для обогащения ответов данными из нормативных документов

### Этап 4: Оптимизация и тестирование

1. Внедрение механизмов кэширования для оптимизации использования токенов
2. Тестирование и отладка работы бота с различными запросами
3. Оптимизация скорости работы и качества ответов

### Этап 5: Внедрение механизма обновления базы знаний

1. Разработка системы для автоматического обновления нормативной базы
2. Создание интерфейса для управления обновлениями
3. Реализация механизма оповещения об изменениях в нормативных документах

## 5. Технические детали реализации

### 5.1. Сбор и обработка документов

- Использование регулярных выражений для извлечения структурированных данных из документов
- Разделение документов на смысловые части для точного поиска
- Создание метаданных для каждого фрагмента документа (тип, метод НК, дата и т.д.)

### 5.2. Создание и управление эмбеддингами

- Генерация векторных представлений с использованием OpenAI API
- Сохранение эмбеддингов в эффективном формате хранения (FAISS или Chroma)
- Оптимизация поисковых запросов для быстрого нахождения релевантных документов

### 5.3. Интеграция RAG в процесс генерации ответов

- Поиск релевантных фрагментов документов на основе запроса пользователя
- Обогащение промпта модели найденными фрагментами
- Структурирование ответа с цитированием и ссылками на нормативные документы

### 5.4. Оптимизация потребления токенов

- Использование кэширования часто запрашиваемых данных
- Предварительная фильтрация документов перед отправкой в модель
- Применение сжатия контекста для уменьшения размера запросов

## 6. Пользовательский интерфейс и UX

### 6.1. Новые кнопки и команды

- Команда для выбора метода НК (/method)
- Кнопки для выбора типа нормативного документа
- Кнопка "Нормативные документы" для просмотра актуальных нормативов по выбранному методу
- Кнопка "Цитата" для получения точной цитаты из нормативного документа

### 6.2. Формат ответов

- Структурированные ответы с разделением на "Ответ ассистента" и "Цитаты из нормативов"
- Указание источников с возможностью получения подробной информации
- Оформление ссылок на нормативные документы с возможностью их просмотра

## 7. Заключение и оценка ресурсов

### 7.1. Ожидаемые результаты

- Полноценный Telegram-бот, интегрированный с базой нормативных документов по НК
- Быстрый и точный поиск по нормативам с цитированием источников
- Оптимизированная система генерации ответов с минимальным использованием токенов

### 7.2. Необходимые ресурсы

- Доступ к API OpenAI для создания эмбеддингов и генерации ответов
- Хостинг для размещения бота и базы знаний
- Регулярное обновление базы нормативных документов

### 7.3. Потенциальные ограничения и риски

- Изменение структуры сайта diagnostpb.ru может потребовать обновления скрапера
- Ограничения API OpenAI по количеству запросов и размеру контекста
- Необходимость периодического обновления базы знаний при изменении нормативных документов
