# Подробное описание тестирования нейроконсультанта с использованием test_runner.py

## Общая информация о системе тестирования

Файл `test_runner.py` предназначен для тестирования нейроконсультанта и позволяет проводить автоматизированные тесты, отправляя вопросы к боту, получая ответы и оценивая их качество. Система тестирования предоставляет следующие возможности:

1. Проведение одиночных тестов с заданным вопросом
2. Проведение серии тестов из файла с вопросами
3. Экспорт результатов тестирования в CSV или Excel формате
4. Оценка ответов по шкале от -2 до +2
5. Сбор метрик: токены, время генерации, стоимость и т.д.
6. Сохранение результатов в базу данных и в файл

## Структура данных для тестирования

### База данных

Система использует таблицу `test_results` в SQLite базе данных со следующей структурой:
- `id` - Уникальный идентификатор теста
- `timestamp` - Дата и время проведения теста
- `tester_id` - ID тестировщика
- `question` - Вопрос для теста
- `answer` - Ответ от нейроконсультанта
- `score` - Оценка ответа от -2 до +2
- `tokens` - Количество использованных токенов
- `comment` - Комментарий тестировщика
- `generation_time` - Время генерации ответа в секундах
- `cost` - Стоимость генерации ответа
- `chunks` - Список использованных чанков из базы знаний (JSON)

### Файлы для хранения результатов

Результаты тестирования могут сохраняться в двух форматах:
- CSV файл (по умолчанию)
- Excel файл (с расширением .xlsx)

## Функциональность test_runner.py

### Режимы работы

`test_runner.py` поддерживает три основных режима работы:

1. **Одиночный тест**:
   ```bash
   python test_runner.py --question "Ваш вопрос"
   ```

2. **Тестирование из файла**:
   ```bash
   python test_runner.py --file questions.txt
   ```
   Где файл `questions.txt` содержит вопросы по одному на строку.

3. **Экспорт результатов**:
   ```bash
   python test_runner.py --export results.csv
   ```
   или
   ```bash
   python test_runner.py --export results.xlsx
   ```

### Дополнительные параметры

- `--output` или `-o`: Путь к файлу для сохранения результатов (по умолчанию `test_results.xlsx`)
- `--tester` или `-t`: ID тестировщика (по умолчанию 999)

## Процесс тестирования

### Одиночный тест

1. Система принимает вопрос через параметр `--question`
2. Отправляет запрос к GPT-модели через функцию `get_gpt_response`
3. Замеряет время выполнения и считает токены
4. Получает ответ от модели
5. Выводит результат на экран
6. Запрашивает оценку от тестировщика (от -2 до +2)
7. Запрашивает комментарий к оценке
8. Сохраняет результат в базу данных и файл

### Тестирование из файла

1. Система загружает вопросы из указанного файла
2. Последовательно проводит тестирование для каждого вопроса по схеме одиночного теста
3. Собирает статистику по всем тестам
4. Выводит общие результаты: среднюю оценку, среднее количество токенов, среднее время генерации и общую стоимость

### Экспорт результатов

1. Система запрашивает результаты тестирования из базы данных
2. Преобразует данные в нужный формат (CSV или Excel)
3. Сохраняет данные в указанный файл

## Технические особенности

1. **Асинхронность**: Система использует `asyncio` для асинхронного выполнения запросов к GPT-модели
2. **Форматирование для Excel**: При экспорте в Excel применяется форматирование с использованием `xlsxwriter`
3. **Логирование**: Все действия логируются через модуль `utils/logger.py`
4. **Подсчет токенов**: Используется модуль `utils/token_counter.py` для учета токенов и стоимости
5. **Векторный поиск**: При тестировании может использоваться векторный поиск по базе знаний для обогащения контекста

## IMPLEMENTATION CHECKLIST:

1. Подготовить тестовые вопросы (создать файл с вопросами или придумать одиночный вопрос)
2. Убедиться, что файл `.env` содержит корректный API-ключ OpenAI
3. Запустить одиночный тест командой `python test_runner.py --question "Ваш вопрос"`
4. При необходимости тестирования из файла, создать файл с вопросами и запустить `python test_runner.py --file questions.txt`
5. Для экспорта результатов использовать команду `python test_runner.py --export results.xlsx`
6. Результаты тестирования можно найти в указанном файле и в базе данных
